// Configuration de base
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════════
// UTILISATEURS (Admins et Joueurs)
// ═══════════════════════════════════════════════════════
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  username  String   @unique
  password  String   // Sera haché (crypté)
  role      Role     @default(PLAYER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ownedGames     Game[]      @relation("GameOwner")
  characters     Character[]
  playerInGames  GamePlayer[]
  assets      Asset[]
  diceRolls   DiceRoll[]
}

enum Role {
  ADMIN   // Le Maître du Jeu (MJ)
  PLAYER  // Les joueurs
}

// ═══════════════════════════════════════════════════════
// PARTIES / UNIVERS DE JEU
// ═══════════════════════════════════════════════════════
model Game {
  id          String   @id @default(uuid())
  name        String
  description String?
  coverImage  String?  // URL de l'image de couverture
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tacticalMap TacticalMap?

  // Personnalisation visuelle (CSS dynamique)
  customStyles Json?    @db.JsonB
  // Exemple: {"backgroundColor": "#1a1a1a", "fontFamily": "Arial", "primaryColor": "#ff6b6b"}

  // Relations
  ownerId       String
  owner         User            @relation("GameOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  players       GamePlayer[]
  characters    Character[]
  customModels  CustomModel[]
  animations    Animation[]
  assets      Asset[] 
  diceRolls   DiceRoll[]
  monsters  Monster[]
}

// ═══════════════════════════════════════════════════════
// LIAISON JOUEUR-PARTIE (Many-to-Many)
// ═══════════════════════════════════════════════════════
model GamePlayer {
  id        String   @id @default(uuid())
  joinedAt  DateTime @default(now())

  gameId    String
  game      Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  
  playerId  String
  player    User     @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([gameId, playerId]) // Un joueur ne peut rejoindre qu'une fois la même partie
}

// ═══════════════════════════════════════════════════════
// MODÈLES PERSONNALISABLES (La Magie JSONB !)
// ═══════════════════════════════════════════════════════
model CustomModel {
  id          String   @id @default(uuid())
  name        String   // Ex: "Fiche Personnage Médiéval", "Véhicule Cyberpunk"
  description String?
  
  // Structure flexible stockée en JSONB
  schema      Json     @db.JsonB
  // Exemple pour un personnage médiéval:
  // {
  //   "stats": {
  //     "Force": { "type": "number", "default": 10, "min": 1, "max": 20 },
  //     "Agilité": { "type": "number", "default": 10, "min": 1, "max": 20 },
  //     "Magie": { "type": "number", "default": 5, "min": 0, "max": 15 }
  //   },
  //   "fields": {
  //     "Nom": { "type": "text", "required": true },
  //     "Race": { "type": "select", "options": ["Humain", "Elfe", "Nain"] }
  //   }
  // }

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  gameId      String
  game        Game        @relation(fields: [gameId], references: [id], onDelete: Cascade)
  characters  Character[]
}

// ═══════════════════════════════════════════════════════
// PERSONNAGES (Instances des Modèles Personnalisables)
// ═══════════════════════════════════════════════════════
model Character {
  id        String   @id @default(uuid())
  name      String
  avatar    String?  // URL de l'image
  
  // Données dynamiques basées sur le CustomModel
  data      Json     @db.JsonB
  // Exemple (selon le schema du CustomModel):
  // {
  //   "stats": { "Force": 15, "Agilité": 12, "Magie": 8 },
  //   "fields": { "Nom": "Aragorn", "Race": "Humain" },
  //   "inventory": ["Épée longue", "Arc", "Potion de soin"]
  // }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  gameId    String
  game      Game        @relation(fields: [gameId], references: [id], onDelete: Cascade)
  
  ownerId   String
  owner     User        @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  modelId   String?
  model     CustomModel? @relation(fields: [modelId], references: [id], onDelete: SetNull)
}

// ═══════════════════════════════════════════════════════
// ANIMATIONS (Le Système Visuel Avancé)
// ═══════════════════════════════════════════════════════
model Animation {
  id          String        @id @default(uuid())
  name        String        // Ex: "Explosion", "Pluie", "Boule de feu"
  description String?
  
  // Fichier média
  fileUrl     String        // URL du sprite/GIF/vidéo
  fileType    AnimationType @default(IMAGE)
  
  // Positionnement sur l'écran
  positionX   Float?        // Coordonnée X (en pixels ou %)
  positionY   Float?        // Coordonnée Y (en pixels ou %)
  width       Float?        // Largeur (en pixels)
  height      Float?        // Hauteur (en pixels)
  
  // Comportement
  duration    Int?          // Durée en millisecondes (null = infini)
  loop        Boolean       @default(false)
  autoPlay    Boolean       @default(false)
  
  // Déclencheur
  trigger     TriggerType   @default(MANUAL)
  triggerData Json?         @db.JsonB
  // Exemple pour CONDITIONAL:
  // { "condition": "character.health < 20", "target": "character_id_123" }
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  gameId      String
  game        Game          @relation(fields: [gameId], references: [id], onDelete: Cascade)
}

enum AnimationType {
  IMAGE    // PNG, JPG
  GIF      // GIF animé
  VIDEO    // MP4, WEBM
  SPRITE   // Spritesheet
}

enum TriggerType {
  MANUAL       // Le MJ clique sur un bouton
  AUTO         // Se déclenche automatiquement au chargement
  CONDITIONAL  // Se déclenche selon une condition (ex: PV < 20%)
  TIMED        // Se déclenche après X secondes
}

model Asset {
  id          String   @id @default(uuid())
  name        String
  filename    String
  url         String
  type        String
  category    String
  size        Int
  gameId      String
  uploaderId  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  uploader    User     @relation(fields: [uploaderId], references: [id])

  @@index([gameId])
  @@index([uploaderId])
  @@map("assets")
}

model DiceRoll {
  id          String   @id @default(uuid())
  gameId      String
  userId      String
  username    String
  
  formula     String
  diceType    Int
  count       Int
  modifier    Int
  
  results     Json
  total       Int
  
  reason      String?
  advantage   Boolean  @default(false)
  disadvantage Boolean @default(false)
  
  createdAt   DateTime @default(now())
  
  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([gameId])
  @@index([userId])
  @@index([gameId, userId])
}

model TacticalMap {
  id            String     @id @default(uuid())
  gameId        String     @unique
  activeSceneId String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  game          Game       @relation(fields: [gameId], references: [id], onDelete: Cascade)
  scenes        MapScene[]
  @@index([gameId])
}

model MapScene {
  id                String      @id @default(uuid())
  tacticalMapId     String
  name              String      @default("Nouvelle Scène")
  order             Int         @default(0)
  gridSize          Int         @default(50)
  gridWidth         Int         @default(30)
  gridHeight        Int         @default(20)
  gridColor         String      @default("#444444")
  gridOpacity       Float       @default(0.5)
  backgroundColor   String      @default("#1a1a1a")
  backgroundImage   String?
  backgroundOpacity Float       @default(1.0)
  cellUnit          String      @default("5ft")
  tokens            Json        @default("[]")
  drawings          Json        @default("[]")
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  tacticalMap       TacticalMap @relation(fields: [tacticalMapId], references: [id], onDelete: Cascade)
  @@index([tacticalMapId])
}

model Monster {
  id          String   @id @default(uuid())
  gameId      String
  
  // Infos de base
  name        String
  avatar      String?
  description String?
  
  // Stats activées (le MJ choisit lesquelles afficher)
  showHp      Boolean  @default(false)
  showAc      Boolean  @default(false)
  showStats   Boolean  @default(false)
  showSpeed   Boolean  @default(false)
  showActions Boolean  @default(false)
  
  // HP
  hp          Int?
  maxHp       Int?
  
  // CA
  ac          Int?
  
  // Stats D&D
  strength    Int?
  dexterity   Int?
  constitution Int?
  intelligence Int?
  wisdom      Int?
  charisma    Int?
  
  // Vitesse
  speed       Int?
  
  // Attaques / Actions (JSON array)
  actions     Json     @default("[]")
  
  // Métadonnées
  challengeRating String?
  type        String?
  size        String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  
  @@index([gameId])
}