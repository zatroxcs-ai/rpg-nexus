// Configuration de base
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════════
// UTILISATEURS (Admins et Joueurs)
// ═══════════════════════════════════════════════════════
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  username  String   @unique
  password  String   // Sera haché (crypté)
  role      Role     @default(PLAYER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ownedGames     Game[]      @relation("GameOwner")
  characters     Character[]
  playerInGames  GamePlayer[]
  assets      Asset[]
  diceRolls   DiceRoll[]
  notes       Note[]
}

enum Role {
  ADMIN   // Le Maître du Jeu (MJ)
  PLAYER  // Les joueurs
}

// ═══════════════════════════════════════════════════════
// PARTIES / UNIVERS DE JEU
// ═══════════════════════════════════════════════════════
model Game {
  id          String   @id @default(uuid())
  name        String
  description String?
  coverImage  String?  // URL de l'image de couverture
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tacticalMap TacticalMap?

  // Personnalisation visuelle (CSS dynamique)
  customStyles Json?    @db.JsonB
  // Exemple: {"backgroundColor": "#1a1a1a", "fontFamily": "Arial", "primaryColor": "#ff6b6b"}

  // Relations
  ownerId       String
  owner         User            @relation("GameOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  players       GamePlayer[]
  characters    Character[]
  customModels  CustomModel[]
  animations    Animation[]
  assets      Asset[] 
  diceRolls   DiceRoll[]
  monsters  Monster[]
  combats   Combat[]
  notes     Note[]
  chatMessages ChatMessage[]
  npcs      Npc[]
  items     Item[]
  relations Relation[]
  quests    Quest[]
  playlists Playlist[]
}

// ═══════════════════════════════════════════════════════
// LIAISON JOUEUR-PARTIE (Many-to-Many)
// ═══════════════════════════════════════════════════════
model GamePlayer {
  id        String   @id @default(uuid())
  joinedAt  DateTime @default(now())

  gameId    String
  game      Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  
  playerId  String
  player    User     @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([gameId, playerId]) // Un joueur ne peut rejoindre qu'une fois la même partie
}

// ═══════════════════════════════════════════════════════
// MODÈLES PERSONNALISABLES (La Magie JSONB !)
// ═══════════════════════════════════════════════════════
model CustomModel {
  id          String   @id @default(uuid())
  name        String   // Ex: "Fiche Personnage Médiéval", "Véhicule Cyberpunk"
  description String?
  
  // Structure flexible stockée en JSONB
  schema      Json     @db.JsonB
  // Exemple pour un personnage médiéval:
  // {
  //   "stats": {
  //     "Force": { "type": "number", "default": 10, "min": 1, "max": 20 },
  //     "Agilité": { "type": "number", "default": 10, "min": 1, "max": 20 },
  //     "Magie": { "type": "number", "default": 5, "min": 0, "max": 15 }
  //   },
  //   "fields": {
  //     "Nom": { "type": "text", "required": true },
  //     "Race": { "type": "select", "options": ["Humain", "Elfe", "Nain"] }
  //   }
  // }

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  gameId      String
  game        Game        @relation(fields: [gameId], references: [id], onDelete: Cascade)
  characters  Character[]
}

// ═══════════════════════════════════════════════════════
// PERSONNAGES (Instances des Modèles Personnalisables)
// ═══════════════════════════════════════════════════════
model Character {
  id        String   @id @default(uuid())
  name      String
  avatar    String?  // URL de l'image
  
  // Données dynamiques basées sur le CustomModel
  data      Json     @db.JsonB
  // Exemple (selon le schema du CustomModel):
  // {
  //   "stats": { "Force": 15, "Agilité": 12, "Magie": 8 },
  //   "fields": { "Nom": "Aragorn", "Race": "Humain" },
  //   "inventory": ["Épée longue", "Arc", "Potion de soin"]
  // }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  gameId    String
  game      Game        @relation(fields: [gameId], references: [id], onDelete: Cascade)
  
  ownerId   String
  owner     User        @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  modelId   String?
  model     CustomModel? @relation(fields: [modelId], references: [id], onDelete: SetNull)
}

// ═══════════════════════════════════════════════════════
// ANIMATIONS (Le Système Visuel Avancé)
// ═══════════════════════════════════════════════════════
model Animation {
  id          String        @id @default(uuid())
  name        String        // Ex: "Explosion", "Pluie", "Boule de feu"
  description String?
  
  // Fichier média
  fileUrl     String        // URL du sprite/GIF/vidéo
  fileType    AnimationType @default(IMAGE)
  
  // Positionnement sur l'écran
  positionX   Float?        // Coordonnée X (en pixels ou %)
  positionY   Float?        // Coordonnée Y (en pixels ou %)
  width       Float?        // Largeur (en pixels)
  height      Float?        // Hauteur (en pixels)
  
  // Comportement
  duration    Int?          // Durée en millisecondes (null = infini)
  loop        Boolean       @default(false)
  autoPlay    Boolean       @default(false)
  
  // Déclencheur
  trigger     TriggerType   @default(MANUAL)
  triggerData Json?         @db.JsonB
  // Exemple pour CONDITIONAL:
  // { "condition": "character.health < 20", "target": "character_id_123" }
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  gameId      String
  game        Game          @relation(fields: [gameId], references: [id], onDelete: Cascade)
}

enum AnimationType {
  IMAGE    // PNG, JPG
  GIF      // GIF animé
  VIDEO    // MP4, WEBM
  SPRITE   // Spritesheet
}

enum TriggerType {
  MANUAL       // Le MJ clique sur un bouton
  AUTO         // Se déclenche automatiquement au chargement
  CONDITIONAL  // Se déclenche selon une condition (ex: PV < 20%)
  TIMED        // Se déclenche après X secondes
}

model Asset {
  id          String   @id @default(uuid())
  name        String
  filename    String
  url         String
  type        String
  category    String
  size        Int
  gameId      String
  uploaderId  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  uploader    User     @relation(fields: [uploaderId], references: [id])

  @@index([gameId])
  @@index([uploaderId])
  @@map("assets")
}

model DiceRoll {
  id          String   @id @default(uuid())
  gameId      String
  userId      String
  username    String
  
  formula     String
  diceType    Int
  count       Int
  modifier    Int
  
  results     Json
  total       Int
  
  reason      String?
  advantage   Boolean  @default(false)
  disadvantage Boolean @default(false)
  
  createdAt   DateTime @default(now())
  
  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([gameId])
  @@index([userId])
  @@index([gameId, userId])
}

model TacticalMap {
  id            String     @id @default(uuid())
  gameId        String     @unique
  activeSceneId String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  game          Game       @relation(fields: [gameId], references: [id], onDelete: Cascade)
  scenes        MapScene[]
  @@index([gameId])
}

model MapScene {
  id                String      @id @default(uuid())
  tacticalMapId     String
  name              String      @default("Nouvelle Scène")
  order             Int         @default(0)
  gridSize          Int         @default(50)
  gridWidth         Int         @default(30)
  gridHeight        Int         @default(20)
  gridColor         String      @default("#444444")
  gridOpacity       Float       @default(0.5)
  backgroundColor   String      @default("#1a1a1a")
  backgroundImage   String?
  backgroundOpacity Float       @default(1.0)
  cellUnit          String      @default("5ft")
  tokens            Json        @default("[]")
  drawings          Json        @default("[]")
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  tacticalMap       TacticalMap @relation(fields: [tacticalMapId], references: [id], onDelete: Cascade)
  @@index([tacticalMapId])
}

model Combat {
  id          String   @id @default(uuid())
  gameId      String
  name        String   @default("Combat")
  status      CombatStatus @default(ACTIVE)
  autoMode    Boolean  @default(false)
  currentTurn Int      @default(0)
  round       Int      @default(1)
  log         Json     @default("[]")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  game         Game              @relation(fields: [gameId], references: [id], onDelete: Cascade)
  participants CombatParticipant[]

  @@index([gameId])
}

model CombatParticipant {
  id          String   @id @default(uuid())
  combatId    String
  type        ParticipantType
  characterId String?
  monsterId   String?
  name        String
  avatar      String?
  initiative  Int      @default(0)
  hp          Int      @default(0)
  maxHp       Int      @default(0)
  ac          Int      @default(10)
  strength    Int      @default(10)
  dexterity   Int      @default(10)
  constitution Int     @default(10)
  intelligence Int     @default(10)
  wisdom      Int      @default(10)
  charisma    Int      @default(10)
  speed       Int      @default(30)
  actions     Json     @default("[]")
  conditions  Json     @default("[]")
  isAlive     Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  combat Combat @relation(fields: [combatId], references: [id], onDelete: Cascade)

  @@index([combatId])
}

enum CombatStatus {
  ACTIVE
  PAUSED
  FINISHED
}

enum ParticipantType {
  CHARACTER
  MONSTER
}

model Monster {
  id          String   @id @default(uuid())
  gameId      String
  
  // Infos de base
  name        String
  avatar      String?
  description String?
  
  // Stats activées (le MJ choisit lesquelles afficher)
  showHp      Boolean  @default(false)
  showAc      Boolean  @default(false)
  showStats   Boolean  @default(false)
  showSpeed   Boolean  @default(false)
  showActions Boolean  @default(false)
  
  // HP
  hp          Int?
  maxHp       Int?
  
  // CA
  ac          Int?
  
  // Stats D&D
  strength    Int?
  dexterity   Int?
  constitution Int?
  intelligence Int?
  wisdom      Int?
  charisma    Int?
  
  // Vitesse
  speed       Int?
  
  // Attaques / Actions (JSON array)
  actions     Json     @default("[]")
  
  // Métadonnées
  challengeRating String?
  type        String?
  size        String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  
  @@index([gameId])
}

// ═══════════════════════════════════════════════════════
// NOTES / JOURNAL DE CAMPAGNE
// ═══════════════════════════════════════════════════════
model Note {
  id          String   @id @default(uuid())
  gameId      String
  authorId    String
  title       String
  content     String   @db.Text
  category    String   @default("session")
  gameDate    String?
  participants Json?    @default("[]")
  isPinned    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([gameId])
  @@index([authorId])
}

model ChatMessage {
  id            String   @id @default(uuid())
  gameId        String
  userId        String
  username      String
  content       String   @db.Text
  isWhisper     Boolean  @default(false)
  targetUserId  String?
  createdAt     DateTime @default(now())

  game          Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@index([gameId])
  @@index([gameId, createdAt])
}

// ═══════════════════════════════════════════════════════
// PNJ (Personnages Non-Joueurs geres par le MJ)
// ═══════════════════════════════════════════════════════
model Npc {
  id          String   @id @default(uuid())
  gameId      String
  name        String
  avatar      String?
  description String?  @db.Text
  role        String?
  location    String?
  isVisible   Boolean  @default(true)

  showHp      Boolean  @default(false)
  showAc      Boolean  @default(false)
  showStats   Boolean  @default(false)
  showSpeed   Boolean  @default(false)
  showActions Boolean  @default(false)

  hp          Int?
  maxHp       Int?
  ac          Int?
  strength    Int?
  dexterity   Int?
  constitution Int?
  intelligence Int?
  wisdom      Int?
  charisma    Int?
  speed       Int?

  actions     Json     @default("[]")
  inventory   Json     @default("[]")
  notes       String?  @db.Text

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@index([gameId])
}

// ═══════════════════════════════════════════════════════
// OBJETS (Items geres par le MJ, assignables aux entites)
// ═══════════════════════════════════════════════════════
model Item {
  id          String   @id @default(uuid())
  gameId      String
  name        String
  description String?  @db.Text
  image       String?
  rarity      String   @default("commun")
  category    String   @default("divers")
  weight      Float?
  value       Int?

  effects     Json     @default("[]")

  isConsumable    Boolean  @default(false)
  duration        Int?
  isActive        Boolean  @default(false)
  remainingTurns  Int?

  assignedToType  String?
  assignedToId    String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@index([gameId])
  @@index([assignedToId])
}

// ═══════════════════════════════════════════════════════
// RELATIONS entre entites (arbre de connaissances/ennemis)
// ═══════════════════════════════════════════════════════
model Relation {
  id          String   @id @default(uuid())
  gameId      String

  sourceType  String
  sourceId    String
  sourceName  String

  targetType  String
  targetId    String
  targetName  String

  type        String   @default("neutre")
  label       String?
  notes       String?  @db.Text

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@index([gameId])
  @@index([sourceId])
  @@index([targetId])
}

// ═══════════════════════════════════════════════════════
// QUETES (Systeme de quetes gere par le MJ)
// ═══════════════════════════════════════════════════════
model Quest {
  id          String      @id @default(uuid())
  gameId      String
  title       String
  description String?     @db.Text
  status      QuestStatus @default(ACTIVE)
  priority    QuestPriority @default(SECONDARY)
  xpReward    Int?
  deadline    String?
  gmNotes     String?     @db.Text
  parentQuestId String?
  sortOrder   Int         @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  game        Game        @relation(fields: [gameId], references: [id], onDelete: Cascade)
  parentQuest Quest?      @relation("QuestChain", fields: [parentQuestId], references: [id], onDelete: SetNull)
  childQuests Quest[]     @relation("QuestChain")
  steps       QuestStep[]
  assignments QuestAssignment[]
  rewards     QuestReward[]

  @@index([gameId])
  @@index([parentQuestId])
}

model QuestStep {
  id          String   @id @default(uuid())
  questId     String
  title       String
  description String?
  isCompleted Boolean  @default(false)
  sortOrder   Int      @default(0)
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  quest       Quest    @relation(fields: [questId], references: [id], onDelete: Cascade)

  @@index([questId])
}

model QuestAssignment {
  id          String   @id @default(uuid())
  questId     String
  entityType  String
  entityId    String
  entityName  String
  entityAvatar String?
  createdAt   DateTime @default(now())

  quest       Quest    @relation(fields: [questId], references: [id], onDelete: Cascade)

  @@unique([questId, entityType, entityId])
  @@index([questId])
}

model QuestReward {
  id          String   @id @default(uuid())
  questId     String
  itemId      String?
  itemName    String
  itemImage   String?
  quantity    Int      @default(1)
  createdAt   DateTime @default(now())

  quest       Quest    @relation(fields: [questId], references: [id], onDelete: Cascade)

  @@index([questId])
}

enum QuestStatus {
  ACTIVE
  COMPLETED
  FAILED
}

enum QuestPriority {
  MAIN
  SECONDARY
  HIDDEN
}

// ═══════════════════════════════════════════════════════
// PLAYLISTS AUDIO (Musique d'ambiance geree par le MJ)
// ═══════════════════════════════════════════════════════
model Playlist {
  id          String   @id @default(uuid())
  gameId      String
  name        String
  description String?
  tracks      Json     @default("[]")
  isActive    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@index([gameId])
}